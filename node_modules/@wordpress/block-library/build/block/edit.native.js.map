{"version":3,"sources":["@wordpress/block-library/src/block/edit.native.js"],"names":["ReusableBlockEdit","ref","attributes","clientId","isSelected","recordArgs","showHelp","setShowHelp","sendFallbackMessage","setSendFallbackMessage","sendButtonPressMessage","setSendButtonPressMessage","timeoutId","infoTextStyle","styles","infoText","infoTextDark","infoTitleStyle","infoTitle","infoTitleDark","infoSheetIconStyle","infoSheetIcon","infoSheetIconDark","actionButtonStyle","actionButton","actionButtonDark","spinnerStyle","spinner","spinnerDark","select","getSettings","reusableBlock","getEditedEntityRecord","hasResolved","hasFinishedResolution","isSaving","isSavingEntityRecord","canUserUpdate","canUser","isEditing","reusableBlocksStore","__experimentalIsEditingReusableBlock","settings","isUnsupportedBlockEditorSupported","unsupportedBlockEditor","canEnableUnsupportedBlockEditor","invalidateResolution","id","blocks","onInput","onChange","clearTimeout","current","openSheet","closeSheet","requestFallback","renderSheet","Platform","OS","reusableBlockActionButton","setTimeout","name","title","actionButtons","missingBlockAlertActionButton","infoContainer","help","color","size","element"],"mappings":"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","sourcesContent":["/**\n * External dependencies\n */\nimport {\n\tActivityIndicator,\n\tPlatform,\n\tText,\n\tTouchableWithoutFeedback,\n\tView,\n} from 'react-native';\n\n/**\n * WordPress dependencies\n */\nimport { useEffect, useRef, useState } from '@wordpress/element';\nimport { useEntityBlockEditor } from '@wordpress/core-data';\nimport { BottomSheet, Icon, Disabled } from '@wordpress/components';\nimport { useSelect, useDispatch } from '@wordpress/data';\nimport { __ } from '@wordpress/i18n';\nimport { BlockEditorProvider, BlockList } from '@wordpress/block-editor';\nimport { usePreferredColorSchemeStyle } from '@wordpress/compose';\nimport { help } from '@wordpress/icons';\nimport {\n\trequestUnsupportedBlockFallback,\n\tsendActionButtonPressedAction,\n\tactionButtons,\n} from '@wordpress/react-native-bridge';\nimport { store as reusableBlocksStore } from '@wordpress/reusable-blocks';\nimport { applyFilters } from '@wordpress/hooks';\n\n/**\n * Internal dependencies\n */\nimport styles from './editor.scss';\nimport EditTitle from './edit-title';\n\nexport default function ReusableBlockEdit( {\n\tattributes: { ref },\n\tclientId,\n\tisSelected,\n} ) {\n\tconst recordArgs = [ 'postType', 'wp_block', ref ];\n\n\tconst [ showHelp, setShowHelp ] = useState( false );\n\tconst [ sendFallbackMessage, setSendFallbackMessage ] = useState( false );\n\tconst [ sendButtonPressMessage, setSendButtonPressMessage ] = useState(\n\t\tfalse\n\t);\n\tconst timeoutId = useRef();\n\tconst infoTextStyle = usePreferredColorSchemeStyle(\n\t\tstyles.infoText,\n\t\tstyles.infoTextDark\n\t);\n\tconst infoTitleStyle = usePreferredColorSchemeStyle(\n\t\tstyles.infoTitle,\n\t\tstyles.infoTitleDark\n\t);\n\tconst infoSheetIconStyle = usePreferredColorSchemeStyle(\n\t\tstyles.infoSheetIcon,\n\t\tstyles.infoSheetIconDark\n\t);\n\tconst actionButtonStyle = usePreferredColorSchemeStyle(\n\t\tstyles.actionButton,\n\t\tstyles.actionButtonDark\n\t);\n\tconst spinnerStyle = usePreferredColorSchemeStyle(\n\t\tstyles.spinner,\n\t\tstyles.spinnerDark\n\t);\n\n\tconst {\n\t\treusableBlock,\n\t\thasResolved,\n\t\tisEditing,\n\t\tsettings,\n\t\tisUnsupportedBlockEditorSupported,\n\t\tcanEnableUnsupportedBlockEditor,\n\t} = useSelect(\n\t\t( select ) => {\n\t\t\tconst { getSettings } = select( 'core/block-editor' );\n\n\t\t\treturn {\n\t\t\t\treusableBlock: select( 'core' ).getEditedEntityRecord(\n\t\t\t\t\t...recordArgs\n\t\t\t\t),\n\t\t\t\thasResolved: select( 'core' ).hasFinishedResolution(\n\t\t\t\t\t'getEditedEntityRecord',\n\t\t\t\t\trecordArgs\n\t\t\t\t),\n\t\t\t\tisSaving: select( 'core' ).isSavingEntityRecord(\n\t\t\t\t\t...recordArgs\n\t\t\t\t),\n\t\t\t\tcanUserUpdate: select( 'core' ).canUser(\n\t\t\t\t\t'update',\n\t\t\t\t\t'blocks',\n\t\t\t\t\tref\n\t\t\t\t),\n\t\t\t\tisEditing: select(\n\t\t\t\t\treusableBlocksStore\n\t\t\t\t).__experimentalIsEditingReusableBlock( clientId ),\n\t\t\t\tsettings: getSettings(),\n\t\t\t\tisUnsupportedBlockEditorSupported:\n\t\t\t\t\tgetSettings( 'capabilities' ).unsupportedBlockEditor ===\n\t\t\t\t\ttrue,\n\t\t\t\tcanEnableUnsupportedBlockEditor:\n\t\t\t\t\tgetSettings( 'capabilities' )\n\t\t\t\t\t\t.canEnableUnsupportedBlockEditor === true,\n\t\t\t};\n\t\t},\n\t\t[ ref, clientId ]\n\t);\n\n\tconst { invalidateResolution } = useDispatch( 'core' );\n\n\tconst [ blocks, onInput, onChange ] = useEntityBlockEditor(\n\t\t'postType',\n\t\t'wp_block',\n\t\t{ id: ref }\n\t);\n\n\tuseEffect( () => {\n\t\treturn () => {\n\t\t\tclearTimeout( timeoutId.current );\n\t\t\t/**\n\t\t\t * Invalidate entity record upon unmount to keep the reusable block updated\n\t\t\t * in case it's modified through UBE\n\t\t\t */\n\t\t\tinvalidateResolution( 'getEntityRecord', recordArgs );\n\t\t};\n\t}, [] );\n\n\tfunction openSheet() {\n\t\tsetShowHelp( true );\n\t}\n\n\tfunction closeSheet() {\n\t\tsetShowHelp( false );\n\t}\n\n\tfunction requestFallback() {\n\t\tcloseSheet();\n\n\t\tif (\n\t\t\tcanEnableUnsupportedBlockEditor &&\n\t\t\t! isUnsupportedBlockEditorSupported\n\t\t) {\n\t\t\tsetSendButtonPressMessage( true );\n\t\t} else {\n\t\t\tsetSendFallbackMessage( true );\n\t\t}\n\t}\n\n\tfunction renderSheet() {\n\t\tconst infoTitle =\n\t\t\tPlatform.OS === 'android'\n\t\t\t\t? __(\n\t\t\t\t\t\t\"Reusable blocks aren't editable on WordPress for Android\"\n\t\t\t\t  )\n\t\t\t\t: __( \"Reusable blocks aren't editable on WordPress for iOS\" );\n\t\tconst reusableBlockActionButton = applyFilters(\n\t\t\t'native.reusable_block_action_button',\n\t\t\t__( 'Edit using web editor' )\n\t\t);\n\n\t\treturn (\n\t\t\t<BottomSheet\n\t\t\t\tisVisible={ showHelp }\n\t\t\t\thideHeader\n\t\t\t\tonClose={ closeSheet }\n\t\t\t\tonModalHide={ () => {\n\t\t\t\t\tif ( sendFallbackMessage ) {\n\t\t\t\t\t\t// On iOS, onModalHide is called when the controller is still part of the hierarchy.\n\t\t\t\t\t\t// A small delay will ensure that the controller has already been removed.\n\t\t\t\t\t\ttimeoutId.current = setTimeout( () => {\n\t\t\t\t\t\t\trequestUnsupportedBlockFallback(\n\t\t\t\t\t\t\t\t`<!-- wp:block {\"ref\":${ reusableBlock.id }} /-->`,\n\t\t\t\t\t\t\t\tclientId,\n\t\t\t\t\t\t\t\treusableBlock.name,\n\t\t\t\t\t\t\t\treusableBlock.title\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tinvalidateResolution(\n\t\t\t\t\t\t\t\t'getEntityRecord',\n\t\t\t\t\t\t\t\trecordArgs\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}, 100 );\n\t\t\t\t\t\tsetSendFallbackMessage( false );\n\t\t\t\t\t} else if ( sendButtonPressMessage ) {\n\t\t\t\t\t\ttimeoutId.current = setTimeout( () => {\n\t\t\t\t\t\t\tsendActionButtonPressedAction(\n\t\t\t\t\t\t\t\tactionButtons.missingBlockAlertActionButton\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}, 100 );\n\t\t\t\t\t\tsetSendButtonPressMessage( false );\n\t\t\t\t\t}\n\t\t\t\t} }\n\t\t\t>\n\t\t\t\t<View style={ styles.infoContainer }>\n\t\t\t\t\t<Icon\n\t\t\t\t\t\ticon={ help }\n\t\t\t\t\t\tcolor={ infoSheetIconStyle.color }\n\t\t\t\t\t\tsize={ styles.infoSheetIcon.size }\n\t\t\t\t\t/>\n\t\t\t\t\t<Text style={ [ infoTextStyle, infoTitleStyle ] }>\n\t\t\t\t\t\t{ infoTitle }\n\t\t\t\t\t</Text>\n\t\t\t\t</View>\n\t\t\t\t{ ( isUnsupportedBlockEditorSupported ||\n\t\t\t\t\tcanEnableUnsupportedBlockEditor ) && (\n\t\t\t\t\t<>\n\t\t\t\t\t\t<BottomSheet.Cell\n\t\t\t\t\t\t\tlabel={ reusableBlockActionButton }\n\t\t\t\t\t\t\tseparatorType=\"topFullWidth\"\n\t\t\t\t\t\t\tonPress={ requestFallback }\n\t\t\t\t\t\t\tlabelStyle={ actionButtonStyle }\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<BottomSheet.Cell\n\t\t\t\t\t\t\tlabel={ __( 'Dismiss' ) }\n\t\t\t\t\t\t\tseparatorType=\"topFullWidth\"\n\t\t\t\t\t\t\tonPress={ closeSheet }\n\t\t\t\t\t\t\tlabelStyle={ actionButtonStyle }\n\t\t\t\t\t\t/>\n\t\t\t\t\t</>\n\t\t\t\t) }\n\t\t\t</BottomSheet>\n\t\t);\n\t}\n\n\tif ( ! hasResolved ) {\n\t\treturn (\n\t\t\t<View style={ spinnerStyle }>\n\t\t\t\t<ActivityIndicator animating />\n\t\t\t</View>\n\t\t);\n\t}\n\n\tif ( ! reusableBlock ) {\n\t\treturn (\n\t\t\t<Text>{ __( 'Block has been deleted or is unavailable.' ) }</Text>\n\t\t);\n\t}\n\n\tconst { title } = reusableBlock;\n\tlet element = (\n\t\t<BlockEditorProvider\n\t\t\tsettings={ settings }\n\t\t\tvalue={ blocks }\n\t\t\tonChange={ onChange }\n\t\t\tonInput={ onInput }\n\t\t>\n\t\t\t<BlockList withFooter={ false } marginHorizontal={ 0 } />\n\t\t</BlockEditorProvider>\n\t);\n\n\tif ( ! isEditing ) {\n\t\telement = <Disabled>{ element }</Disabled>;\n\t}\n\n\treturn (\n\t\t<TouchableWithoutFeedback\n\t\t\tdisabled={ ! isSelected }\n\t\t\taccessibilityLabel={ __( 'Help button' ) }\n\t\t\taccessibilityRole={ 'button' }\n\t\t\taccessibilityHint={ __( 'Tap here to show help' ) }\n\t\t\tonPress={ openSheet }\n\t\t>\n\t\t\t<View>\n\t\t\t\t{ isSelected && <EditTitle title={ title } /> }\n\t\t\t\t{ element }\n\t\t\t\t{ renderSheet() }\n\t\t\t</View>\n\t\t</TouchableWithoutFeedback>\n\t);\n}\n"]}