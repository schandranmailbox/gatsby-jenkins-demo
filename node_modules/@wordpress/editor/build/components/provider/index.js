"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _element = require("@wordpress/element");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _data = require("@wordpress/data");

var _i18n = require("@wordpress/i18n");

var _coreData = require("@wordpress/core-data");

var _blockEditor = require("@wordpress/block-editor");

var _reusableBlocks = require("@wordpress/reusable-blocks");

var _notices = require("@wordpress/notices");

var _withRegistryProvider = _interopRequireDefault(require("./with-registry-provider"));

var _store = require("../../store");

var _useBlockEditorSettings = _interopRequireDefault(require("./use-block-editor-settings"));

/**
 * WordPress dependencies
 */

/**
 * Internal dependencies
 */
function EditorProvider(_ref) {
  var __unstableTemplate = _ref.__unstableTemplate,
      post = _ref.post,
      settings = _ref.settings,
      recovery = _ref.recovery,
      initialEdits = _ref.initialEdits,
      children = _ref.children;
  var defaultBlockContext = (0, _element.useMemo)(function () {
    if (post.type === 'wp_template') {
      return {};
    }

    return {
      postId: post.id,
      postType: post.type
    };
  }, [post.id, post.type]);

  var _useSelect = (0, _data.useSelect)(function (select) {
    var _select = select(_store.store),
        getEditorSelectionStart = _select.getEditorSelectionStart,
        getEditorSelectionEnd = _select.getEditorSelectionEnd,
        __unstableIsEditorReady = _select.__unstableIsEditorReady;

    return {
      isReady: __unstableIsEditorReady(),
      selectionStart: getEditorSelectionStart(),
      selectionEnd: getEditorSelectionEnd()
    };
  }, []),
      selectionEnd = _useSelect.selectionEnd,
      selectionStart = _useSelect.selectionStart,
      isReady = _useSelect.isReady;

  var _ref2 = __unstableTemplate !== null && __unstableTemplate !== void 0 ? __unstableTemplate : post,
      id = _ref2.id,
      type = _ref2.type;

  var _useEntityBlockEditor = (0, _coreData.useEntityBlockEditor)('postType', type, {
    id: id
  }),
      _useEntityBlockEditor2 = (0, _slicedToArray2.default)(_useEntityBlockEditor, 3),
      blocks = _useEntityBlockEditor2[0],
      onInput = _useEntityBlockEditor2[1],
      onChange = _useEntityBlockEditor2[2];

  var editorSettings = (0, _useBlockEditorSettings.default)(settings, !!__unstableTemplate);

  var _useDispatch = (0, _data.useDispatch)(_store.store),
      updatePostLock = _useDispatch.updatePostLock,
      setupEditor = _useDispatch.setupEditor,
      updateEditorSettings = _useDispatch.updateEditorSettings,
      __experimentalTearDownEditor = _useDispatch.__experimentalTearDownEditor;

  var _useDispatch2 = (0, _data.useDispatch)(_notices.store),
      createWarningNotice = _useDispatch2.createWarningNotice; // Iniitialize and tear down the editor.
  // Ideally this should be synced on each change and not just something you do once.


  (0, _element.useLayoutEffect)(function () {
    // Assume that we don't need to initialize in the case of an error recovery.
    if (recovery) {
      return;
    }

    updatePostLock(settings.postLock);
    setupEditor(post, initialEdits, settings.template);

    if (settings.autosave) {
      createWarningNotice((0, _i18n.__)('There is an autosave of this post that is more recent than the version below.'), {
        id: 'autosave-exists',
        actions: [{
          label: (0, _i18n.__)('View the autosave'),
          url: settings.autosave.editLink
        }]
      });
    }

    return function () {
      __experimentalTearDownEditor();
    };
  }, []); // Synchronize the editor settings as they change

  (0, _element.useEffect)(function () {
    updateEditorSettings(settings);
  }, [settings]);

  if (!isReady) {
    return null;
  }

  return (0, _element.createElement)(_coreData.EntityProvider, {
    kind: "root",
    type: "site"
  }, (0, _element.createElement)(_coreData.EntityProvider, {
    kind: "postType",
    type: post.type,
    id: post.id
  }, (0, _element.createElement)(_blockEditor.BlockContextProvider, {
    value: defaultBlockContext
  }, (0, _element.createElement)(_blockEditor.BlockEditorProvider, {
    value: blocks,
    onChange: onChange,
    onInput: onInput,
    selectionStart: selectionStart,
    selectionEnd: selectionEnd,
    settings: editorSettings,
    useSubRegistry: false
  }, children, (0, _element.createElement)(_reusableBlocks.ReusableBlocksMenuItems, null)))));
}

var _default = (0, _withRegistryProvider.default)(EditorProvider);

exports.default = _default;
//# sourceMappingURL=index.js.map